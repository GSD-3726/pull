name: è§¦å‘giteeå·¥ä½œæµ

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      tag_name:
        description: 'Github actions è§¦å‘'
        required: false
        default: ''
  schedule:
    # å¯é€‰ï¼šè®¾ç½®å®šæ—¶è§¦å‘ï¼Œä¾‹å¦‚æ¯å¤© UTC æ—¶é—´ 8:00ï¼ˆåŒ—äº¬æ—¶é—´ 16:00ï¼‰
    - cron: '0 8 * * *'

env:
  GITEE_REPO: 'bmg369/test' # æ›¿æ¢ä¸ºä½ çš„ Gitee ä»“åº“è·¯å¾„

jobs:
  trigger-gitee-pipeline:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²è®°å½•
          token: ${{ secrets.PAT_FOR_CI }} # ä½¿ç”¨ PAT è€Œä¸æ˜¯é»˜è®¤çš„ GITHUB_TOKEN

      - name: Setup Git configuration
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Generate tag name
        id: tag_name
        run: |
          if [ -n "${{ github.event.inputs.tag_name }}" ]; then
            echo "TAG_NAME=${{ github.event.inputs.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "TAG_NAME=trigger-pipeline-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
          fi
          echo "Using tag name: $TAG_NAME"

      - name: Create and push lightweight tag to Gitee
        run: |
          TAG_NAME="${{ steps.tag_name.outputs.TAG_NAME }}"
          
          # åˆ›å»ºè½»é‡çº§æ ‡ç­¾
          git tag $TAG_NAME
          
          # æ¨é€åˆ° Gitee
          git push https://${{ secrets.GITEE_USERNAME }}:${{ secrets.GITEE_TOKEN }}@gitee.com/${{ env.GITEE_REPO }}.git $TAG_NAME
          
          echo "âœ… Successfully created and pushed tag '$TAG_NAME' to Gitee"

      - name: Clean up local tag
        if: always() # æ— è®ºæˆåŠŸå¤±è´¥éƒ½æ‰§è¡Œæ¸…ç†
        run: |
          TAG_NAME="${{ steps.tag_name.outputs.TAG_NAME }}"
          git tag -d $TAG_NAME || echo "Local tag '$TAG_NAME' already deleted or not found"

      - name: Verify Gitee pipeline trigger
        run: |
          echo "ğŸ¯ Gitee pipeline should now be triggered by tag: ${{ steps.tag_name.outputs.TAG_NAME }}"
          echo "ğŸ“‹ Check your Gitee Go pipeline status at:"
          echo "   https://gitee.com/${{ env.GITEE_REPO }}/pipelines"
