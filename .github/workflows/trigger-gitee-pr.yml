name: Trigger Gitee Pipeline

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'github actions'
        required: false
        default: ''

env:
  GITEE_REPO: "${{ secrets.GITEE_USERNAME }}"  # 带引号的正确写法

jobs:
  trigger-gitee-pipeline:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ github.token }}  # 修复：添加 token 参数

      - name: Setup Git configuration
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Generate tag name
        id: tag_name
        run: |
          if [ -n "${{ github.event.inputs.tag_name }}" ]; then
            echo "TAG_NAME=${{ github.event.inputs.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "TAG_NAME=trigger-pipeline-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
          fi

      - name: Create and push lightweight tag to Gitee
        run: |
          TAG_NAME="${{ steps.tag_name.outputs.TAG_NAME }}"
          git tag $TAG_NAME
          git push https://${{ secrets.GITEE_USERNAME }}:${{ secrets.GITEE_TOKEN }}@gitee.com/${{ env.GITEE_REPO }}.git $TAG_NAME
          echo "✅ 成功创建并推送标签 '$TAG_NAME' 到 Gitee"
