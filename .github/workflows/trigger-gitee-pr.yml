name: 定时同步触发Gitee流水线

on:
  schedule:
    - cron: '0 */2 * * *'  # UTC 每两小时触发一次
  workflow_dispatch:

jobs:
  trigger-gitee-pipeline:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout GitHub Repo
        uses: actions/checkout@v4

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      - name: Clone and Sync Once
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_REPO: "https://gitee.com/bmg369/test.git"
          GITEE_BRANCH: "master"
        run: |
          # 克隆Gitee仓库到 test 目录
          git clone --depth 1 -b $GITEE_BRANCH https://oauth2:${GITEE_TOKEN}@${GITEE_REPO#https://} test

          # 如果存在标志文件则跳过（用来只做一次初始同步）
          if [ -f test/.sync-complete ]; then
            echo "已检测到同步完成标志，跳过后续操作"
            exit 0
          fi

          cd test
          touch .sync-complete
          git add .sync-complete

          # 在自动提交中带上 [skip ci]，避免触发 Gitee CI（如果 Gitee 支持该标记）
          git commit -m "完成首次同步 [skip ci]" || echo "无更改可提交"
          git push origin $GITEE_BRANCH || echo "push 失败"
          echo "Gitee 仓库已同步，后续触发将跳过同步操作"
