name: Trigger Gitee Pipeline

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  trigger-gitee:
    runs-on: ubuntu-latest
    # 只在push事件或合并的pull_request时触发
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Trigger Gitee Go Pipeline
      env:
        GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
      run: |
        curl -X POST \
          "https://gitee.com/api/v5/repos/bmg369/test/trigger/pipeline" \
          -H "Content-Type: application/json" \
          -H "User-Agent: GitHub-Actions" \
          -d '{
            "access_token": "${{ secrets.GITEE_TOKEN }}",
            "env": {
              "GITHUB_TRIGGER": "true",
              "GITHUB_SHA": "${{ github.sha }}",
              "GITHUB_REF": "${{ github.ref }}",
              "GITHUB_EVENT": "${{ github.event_name }}",
              "GITHUB_PAT": "${{ secrets.GITHUB_PAT }}"
            },
            "hook": {
              "push": {
                "commits": [{
                  "message": "Triggered by GitHub Actions - ${{ github.sha }}"
                }]
              }
            }
          }'
        echo "✅ Gitee Go pipeline triggered successfully"
