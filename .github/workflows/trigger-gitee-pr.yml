name: Trigger Gitee Pipeline

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: '自定义标签名（留空则自动生成）'
        required: false
        default: ''

env:
  GITEE_REPO: "${{ secrets.GITEE_USERNAME }}/${{ secrets.GITEE_REPO_NAME }}"  # 修正仓库路径

jobs:
  trigger-gitee-pipeline:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ github.token }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Generate Tag Name
        id: tag_name
        run: |
          TAG_NAME="${{ github.event.inputs.tag_name }}"
          if [ -z "$TAG_NAME" ]; then
            TAG_NAME="trigger-pipeline-$(date +%Y%m%d-%H%M%S)"
          fi
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: Create & Push Annotated Tag
        run: |
          git tag -a ${{ steps.tag_name.outputs.TAG_NAME }} -m "Auto-tag from GitHub Actions"
          git push https://${{ secrets.GITEE_USERNAME }}:${{ secrets.GITEE_TOKEN }}@gitee.com/${{ env.GITEE_REPO }}.git ${{ steps.tag_name.outputs.TAG_NAME }}
